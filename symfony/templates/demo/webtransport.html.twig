{% extends 'base.html.twig' %}

{% block title %}WebTransport Demo{% endblock %}

{% block body %}
  <h1>WebTransport Demo</h1>

  <p>
    Target: <code id="target-url">{{ wt_url }}</code>
    {% if cert_digest_hex %}
      <br>
      Cert (sha-256): <code>{{ cert_digest_hex }}</code>
    {% endif %}
  </p>

  <div style="display:flex; gap: 0.75rem; align-items:center; flex-wrap: wrap; margin: 1rem 0;">
    <button id="connect">Connect</button>
    <button id="send" disabled>Send Datagram</button>
  </div>

  <div style="display:flex; gap: 0.75rem; align-items:center; flex-wrap: wrap; margin: 1rem 0;">
    <input id="payload" type="text" value="hello from browser" style="min-width: 320px;">
  </div>

  <h2>Log</h2>
  <pre id="log" style="background:#0b1020;color:#d7e2ff;padding:1rem;border-radius:10px;overflow:auto;min-height:220px; width:min(900px, 100%);"></pre>

  <script>
    const WT_URL = {{ wt_url|json_encode|raw }};
    const HASH = new Uint8Array({{ cert_digest_bytes|json_encode|raw }});

    let transport;
    let dgramWriter;

    function log(line) {
      const el = document.getElementById("log");
      el.textContent += line + "\n";
      el.scrollTop = el.scrollHeight;
    }

    async function connect() {
      log("Connecting to " + WT_URL);

      try {
        transport = new WebTransport(WT_URL, {
          serverCertificateHashes: [{ algorithm: "sha-256", value: HASH.buffer }]
        });
      } catch (e) {
        log("Failed to create WebTransport: " + e);
        return;
      }

      try {
        await transport.ready;
        log("WebTransport ready");
      } catch (e) {
        log("WebTransport failed: " + e);
        return;
      }

      transport.closed
        .then(() => log("WebTransport closed"))
        .catch((e) => log("WebTransport closed abruptly: " + e));

      dgramWriter = transport.datagrams.writable.getWriter();
      readDatagrams();

      document.getElementById("connect").disabled = true;
      document.getElementById("send").disabled = false;
    }

    async function sendDatagram() {
      const payload = document.getElementById("payload").value;
      const bytes = new TextEncoder().encode(payload);

      try {
        await dgramWriter.write(bytes);
        log("Sent datagram: " + payload);
      } catch (e) {
        log("Datagram send failed: " + e);
      }
    }

    async function readDatagrams() {
      const reader = transport.datagrams.readable.getReader();
      const decoder = new TextDecoder("utf-8");
      log("Datagram reader ready");

      while (true) {
        const { value, done } = await reader.read();
        if (done) {
          log("Datagram reader done");
          return;
        }

        log("Received datagram: " + decoder.decode(value));
      }
    }

    document.getElementById("connect").addEventListener("click", connect);
    document.getElementById("send").addEventListener("click", sendDatagram);
  </script>
{% endblock %}

