services:
  gateway:
    build: ./gateway
    environment:
      - RUST_LOG=info
      - WEBTRANSPORT_PORT=4433
      - HTTP_API_PORT=8080
      - CERT_PEMFILE=/run/certs/dev_cert.pem
      - KEY_PEMFILE=/run/certs/dev_key.pem
      - SYMFONY_WEBHOOK_URL=http://symfony:8000/gateway/events
    ports:
      # WebTransport runs over HTTP/3/QUIC (UDP). We map both TCP+UDP for convenience.
      - "8444:4433"
      - "8444:4433/udp"
    volumes:
      - ./gateway/certs:/run/certs:ro

  symfony:
    build:
      context: .
      dockerfile: symfony/Dockerfile
    environment:
      - APP_ENV=dev
      - APP_DEBUG=1
      - APP_SECRET=dev-secret
      - WT_URL=https://localhost:8444/
      - WT_CERT_PEMFILE=/run/certs/dev_cert.pem
      - GATEWAY_HTTP_BASE_URL=http://gateway:8080
    ports:
      - "8183:8000"
    volumes:
      - ./gateway/certs:/run/certs:ro
